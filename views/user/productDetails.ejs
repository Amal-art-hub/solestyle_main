<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= product.name %> | SoleStyle
    </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/user/homestyle.css">

    <link rel="stylesheet" href="/css/user/productDetails.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <%- include('../partials/header') %>

        <% const uniqueColors=[...new Set(variants.map(v=> v.color))];
            %>

            <div class="product-detail-container">
             
                <div class="breadcrumbs">
                    <a href="/">Home</a> >
                    <a href="/mens-products?category=<%= product.categoryId._id %>">
                        <%= product.categoryId.name %>
                    </a> >
                    <span>
                        <%= product.name %>
                    </span>
                </div>

                <div class="product-main-wrapper">
                  
                    <div class="product-gallery">
                        <div class="thumbnails-column">
                            <% if (variants && variants.length> 0 && variants[0].images) { %>
                                <% variants[0].images.forEach((img, index)=> { %>
                                    <div class="thumbnail-wrapper <%= index === 2? 'active' : '' %>"
                                        data-image="<%= img %>">
                                        <img src="/uploads/variant-images/<%= img %>" alt="Thumbnail">
                                    </div>
                                    <% }) %>
                                        <% } %>
                        </div>
                        <div class="main-image-wrapper">
                           
                            <img id="mainImage" src="/uploads/variant-images/<%= currentVariant.images[2] %>"
                                alt="<%= product.name %>">
                            <div class="zoom-lens"></div>
                        </div>
                    </div>

                   
                    <div class="product-info-column">
                        <h1 class="product-title">
                            <%= product.name %>
                        </h1>
                        <p class="brand-name">Brand: <span>
                                <%= product.brandId.name %>
                            </span></p>
                       
                        <div class="product-rating" style="color: #ffc107; margin-bottom: 10px;">
                            <% for(let i=1; i<=5; i++) { %>
                                <i class="<%= i <= Math.round(avgRating || 0) ? 'fas' : 'far' %> fa-star"></i>
                                <% } %>
                                    <span style="color: #666; font-size: 0.9em;">(<%= reviews ? reviews.length : 0 %>
                                            Reviews)</span>
                        </div>

                       <div class="price-section">
    <% if (currentVariant.offerPercentage > 0) { %>
        <!-- Case A: Active Offer Exists -->
        
        <!-- 1. Discounted (Sale) Price -->
        <span class="current-price" style="color: #d9534f; font-weight: bold; font-size: 1.5em;">
            ₹<span id="displayPrice"><%= currentVariant.discountedPrice %></span>
        </span>

        <!-- 2. Original Price (Struck through) -->
        <span class="original-price" id="displayOriginalPrice" 
              style="text-decoration: line-through; color: #888; margin-left: 10px; font-size: 1.1em;">
            ₹<%= currentVariant.basePrice %>
        </span>

        <!-- 3. Offer Badge -->
        <span class="offer-badge" id="displayBadge" 
              style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px; vertical-align: middle;">
            <%= currentVariant.offerPercentage %>% OFF
        </span>

    <% } else { %>
        <!-- Case B: No Offer (Regular Price) -->
        <span class="current-price" style="color: #333; font-weight: bold; font-size: 1.5em;">
            ₹<span id="displayPrice"><%= currentVariant.price %></span>
        </span>
        
        <!-- Hidden elements for JS to toggle if user switches variant -->
        <span class="original-price" id="displayOriginalPrice" style="display:none; text-decoration: line-through; color: #888; margin-left: 10px;"></span>
        <span class="offer-badge" id="displayBadge" style="display:none; background: #28a745; color: white; padding: 2px 8px; margin-left: 10px;"></span>
    <% } %>

    <!-- Stock Status Logic -->
    <% if (currentVariant.stock > 0) { %>
        <span class="stock-status in-stock" style="display: block; margin-top: 5px; color: #28a745;">
            In Stock
        </span>
    <% } else { %>
        <span class="stock-status out-of-stock" style="display: block; margin-top: 5px; color: #dc3545;">
            Out of Stock
        </span>
    <% } %>
</div>

                        <div class="description-box">
                            <p>
                                <%= product.description %>
                            </p>
                        </div>

                        <!-- [CHANGE] New Color Selector Section -->
                        <div class="color-selector">
                            <h3>Select Color</h3>
                            <div class="color-options">
                                <% uniqueColors.forEach((color, index)=> { %>
                                    <!-- The 'active' class on the first one sets the default color -->
                                    <div class="color-btn <%= index === 0 ? 'active' : '' %>"
                                        onclick="filterByColor(this, '<%= color %>')">
                                        <%= color %>
                                    </div>
                                    <% }) %>
                            </div>
                        </div>

                        <!-- Variant Selection -->
                        <div class="variant-selector">
                            <h3>Select Size (UK/India)</h3>
                     <div class="size-options">
    <% variants.forEach(v => { %>
        <!-- Update this div with NEW data attributes -->
        <div class="size-box <%= v._id.toString() === currentVariant._id.toString() ? 'selected' : '' %>"
            data-price="<%= v.discountedPrice || v.price %>" 
            data-stock="<%= v.stock %>"
            data-variant-id="<%= v._id %>" 
            data-color="<%= v.color %>"
            data-image="<%= v.images[0] %>"
            
            data-original-price="<%= v.basePrice %>"   
            data-discount="<%= v.offerPercentage || 0 %>"
        >
            <%= v.size %>
        </div>
    <% }) %>
</div>
                        </div>

                        <input type="hidden" id="selectedVariantId" value="<%= currentVariant._id %>">
                        <input type="hidden" id="productId" value="<%= product._id %>">

                        <div class="action-buttons">
                            <button class="btn-add-cart" onclick="addToCart()">
                                <i class="fa fa-shopping-cart"></i> Add to Cart
                            </button>
                            <button class="btn-buy-now">Buy Now</button>
                            <!-- <button class="checkout-btn"   >
                                    
                                    Proceed to Checkout
                                </button> -->
                            <button class="btn-wishlist" onclick="addToWishlist()"><i class="fa fa-heart"></i></button>
                        </div>

                        <div class="delivery-info">
                            <div class="info-item">
                                <i class="fa fa-truck"></i>
                                <span>Free Delivery on orders above ₹1000</span>
                            </div>
                            <div class="info-item">
                                <i class="fa fa-undo"></i>
                                <span>7 Days Return Policy</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div class="product-extra-details"
                    style="margin: 40px 0; padding: 20px; background: #fff; border-radius: 8px;">
                    <h2>Customer Reviews</h2>
                    <div class="reviews-list" style="margin-top: 20px;">
                        <% if(reviews && reviews.length> 0) { %>
                            <% reviews.forEach(r=> { %>
                                <div class="review-item" style="border-bottom: 1px solid #eee; padding: 15px 0;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <strong>
                                            <%= r.user_id ? r.user_id.name : 'Anonymous' %>
                                        </strong>
                                        <div style="color: #ffc107;">
                                            <% for(let i=1; i<=5; i++) { %>
                                                <i class="<%= i <= r.rating ? 'fas' : 'far' %> fa-star"></i>
                                                <% } %>
                                        </div>
                                    </div>
                                    <p style="color: #555; margin: 5px 0;">
                                        <%= r.description %>
                                    </p>
                                    <small style="color: #999;">
                                        <%= new Date(r.createdAt).toDateString() %>
                                    </small>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <p>No reviews yet.</p>
                                        <% } %>
                    </div>
                </div>

                <!-- Related Products -->
                <div class="related-products-section">
                    <h2>You May Also Like</h2>
                    <div class="related-grid">
                        <% relatedProducts.forEach(p=> { %>
                            <div class="product-card small">
                                <!-- <a href="/product/<%= p._id %>"> -->
                                    <a href="/product/<%= p._id %>?variantId=<%= p.variantId %>">
                                    <img src="/uploads/variant-images/<%= p.image %>" alt="<%= p.name %>">
                                    <div class="info">
                                        <h3>
                                            <%= p.name %>
                                        </h3>
                                        <p class="price">₹<%= p.price %>
                                        </p>
                                    </div>
                                </a>
                            </div>
                            <% }) %>
                    </div>
                </div>
            </div>

            <%- include('../partials/footer') %>
                <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
                <!-- Link to the JS file you created -->

                <!-- Store data in a hidden element to avoid IDE syntax errors in script tags -->
                <div id="variant-images-data" data-images='<%- JSON.stringify(variants.reduce((acc, v) => {
                    acc[v.color] = v.images;
                    return acc;
                }, {})) %>' style="display: none;"></div>

                <script>
                    const dataElement = document.getElementById('variant-images-data');
                    const variantImages = JSON.parse(dataElement.getAttribute('data-images'));
                </script>

                <script src="/js/user/productDetails.js"></script>
                <script src="/js/user/cart.js"></script>
</body>

</html>