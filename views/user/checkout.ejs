<%- include("../partials/header") %>
    <link rel="stylesheet" href="/css/user/checkout.css">
    <link rel="stylesheet" href="/css/user/homestyle.css">
    <link rel="stylesheet" href="/css/user/address.css">

    <div class="checkout-container">
        <div class="checkout-header">
            <h1>Checkout</h1>
            <div class="breadcrumb">Cart > Checkout > Payment</div>
        </div>

        <div class="checkout-content">
            <!-- LEFT COLUMN: Address Selection & Payment -->
            <div class="checkout-left">

                <!-- Address Section -->
                <div class="section-title">
                    <i class="fas fa-map-marker-alt"></i> Delivery Address
                </div>

                <form id="checkoutForm">
                    <div class="address-list">
                        <% if (addresses && addresses.length> 0) { %>
                            <% addresses.forEach((addr, index)=> { %>
                                <label class="address-card" style="position: relative;">
                                    <input type="radio" name="selectedAddress" value="<%= addr._id %>" <%=index===0
                                        ? 'checked' : '' %>>
                                    <div class="radio-mark"></div>
                                    <div class="address-details">
                                        <strong>
                                            <%= addr.name %> <span class="badge">
                                                    <%= addr.type %>
                                                </span>
                                        </strong>
                                        <p>
                                            <%= addr.address_line1 %>, <%= addr.address_line2 %>
                                        </p>
                                        <p>
                                            <%= addr.city %>, <%= addr.state %> - <%= addr.postal_code %>
                                        </p>
                                        <p>Phone: <%= addr.phone %>
                                        </p>
                                    </div>
                                    <button type="button" onclick="event.preventDefault(); openEditModal(this)"
                                        data-id="<%= addr._id %>" data-name="<%= addr.name %>"
                                        data-phone="<%= addr.phone %>" data-line1="<%= addr.address_line1 %>"
                                        data-line2="<%= addr.address_line2 %>" data-city="<%= addr.city %>"
                                        data-state="<%= addr.state %>" data-postal="<%= addr.postal_code %>"
                                        data-default="<%= addr.is_default_shipping %>" style="
                                            position: absolute; 
                                            top: 15px; 
                                            right: 15px; 
                                            background: #eff2f5; /* Light grey background */
                                            color: #333; 
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            padding: 5px 10px;
                                            font-size: 0.85rem;
                                            font-weight: 600;
                                            cursor: pointer;
                                            z-index: 10;
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            transition: all 0.2s;" onmouseover="this.style.background='#e2e6ea'"
                                        onmouseout="this.style.background='#eff2f5'">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </label>
                                <% }) %>
                                    <% } else { %>
                                        <div class="no-address">
                                            <p>No addresses found. Please add one to proceed.</p>
                                        </div>
                                        <% } %>

                                            <button type="button" class="add-address-btn" onclick="openAddModal()"
                                                style="width: 100%; text-align: center; margin-top: 10px;">
                                                <i class="fas fa-plus"></i> &nbsp; Add New Address
                                            </button>
                    </div>



                    <!-- Payment Section -->
                    <div class="payment-section">
                        <div class="section-title">
                            <i class="fas fa-credit-card"></i> Payment Method
                        </div>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="COD" checked>
                            <span>Cash on Delivery (COD)</span>
                            <i class="fas fa-money-bill-wave" style="margin-left:auto; color:#666;"></i>
                        </label>
                        <label class="payment-option disabled">
                            <input type="radio" name="paymentMethod" value="Online" disabled>
                            <span>Online Payment</span>
                            <span
                                style="font-size:0.75rem; background:#eee; padding:2px 6px; border-radius:4px; margin-left:8px;">Coming
                                Soon</span>
                            <i class="fas fa-lock" style="margin-left:auto; color:#999;"></i>
                        </label>
                    </div>
                </form>
            </div>






            <!-- Add/Edit Address Modal -->
            <div id="addressModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <h2 id="modalTitle">Add New Address</h2>

                    <form id="addressForm">
                        <!-- HIDDEN INPUT TO STORE ADDRESS ID FOR EDITING -->
                        <input type="hidden" id="editAddressId" name="editAddressId">

                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="name" name="name" required>
                        </div>

                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" id="phone" name="phone" required>
                        </div>

                        <div class="form-group">
                            <label>Address Line 1</label>
                            <input type="text" id="address_line1" name="address_line1" required>
                        </div>

                        <div class="form-group">
                            <label>Address Line 2 (Optional)</label>
                            <input type="text" id="address_line2" name="address_line2">
                        </div>

                        <div class="form-group">
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <label>City</label>
                                    <input type="text" id="city" name="city" required>
                                </div>
                                <div style="flex: 1;">
                                    <label>State</label>
                                    <input type="text" id="state" name="state" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Postal Code</label>
                            <input type="text" id="postal_code" name="postal_code" required>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="defaultShipping" name="is_default_shipping"> Set as default
                                shipping
                                address
                            </label>
                        </div>

                        <button type="submit" class="btn-add" style="width: 100%;">Save Address</button>
                    </form>
                </div>
            </div>

            <!-- RIGHT COLUMN: Order Summary -->
            <div class="checkout-right">
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-items">
                        <% cart.items.forEach(item=> { %>
                            <div class="summary-item">

                                <div class="item-image"
                                    style="width: 50px; height: 50px; margin-right: 10px; border-radius: 4px; overflow: hidden; border: 1px solid #eee;">
                                    <img src="/uploads/variant-images/<%= item.image_snapshot %>"
                                        alt="<%= item.name_snapshot %>"
                                        style="width: 100%; height: 100%; object-fit: cover;">
                                </div>

                                <div class="item-name">
                                    <%= item.name_snapshot %>
                                        <span style="color:#999; font-size:0.85rem;">x<%= item.quantity %></span>
                                        <div style="font-size:0.8rem; color:#999;">Size: <%= item.variant_id.size %>
                                        </div>
                                </div>
                                <div class="item-price">₹<%= item.price_at_addition * item.quantity %>
                                </div>
                            </div>
                            <% }) %>
                    </div>

                    <hr>

                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>₹<%= subtotal %></span>
                    </div>
                   
                    
                    <!-- NEW DISCOUNT ROW -->
                    <div class="summary-row">
                        <span>Discount</span>
                        <span style="color: #e74c3c;">- ₹<%= typeof discount !== 'undefined' ? discount : 0 %></span>
                    </div>
                    
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span style="color:var(--success-color);">Free</span>
                    </div>
           

                    <div class="summary-row total">
                        <span>Total Amount</span>
                        <span>₹<%= subtotal %></span>
                    </div>

                    <button type="button" class="place-order-btn" onclick="placeOrder()">
                        Place Order &nbsp; <i class="fas fa-arrow-right"></i>
                    </button>

                    <div class="secure-note">
                        <i class="fas fa-shield-alt"></i> Secure Checkout
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/user/checkout.js"></script>
    <script src="/js/user/address.js"></script>

    <%- include("../partials/footer") %>