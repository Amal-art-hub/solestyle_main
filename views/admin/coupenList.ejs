<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Coupon Management</title>
    <link rel="stylesheet" href="/css/admin/dashboard-side.css">
    <link rel="stylesheet" href="/css/admin/coupenList.css?v=<%= Date.now() %>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div class="container">
        <%- include("../partials/adminSideBar",{activePage: 'coupons' }) %>

            <div class="main-content">
                <section class="content-main">
                    <div class="content-header">
                        <div>
                            <h2 class="content-title card-title">Coupon Management</h2>
                        </div>
                        <div>
                            <!-- Button triggers modal -->
                            <button onclick="openModal('add')" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create New Coupon
                            </button>
                        </div>
                    </div>
                    <!-- Search -->
                    <div class="search-container">
                        <form action="/admin/coupons" method="GET" class="filter-form">
                            <input type="text" name="search" placeholder="Search coupons..." class="search-input"
                                value="<%= search %>">
                            <button type="submit" class="btn-search">Search</button>
                        </form>
                    </div>
                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Discount</th>
                                    <th>Min Purchase</th>
                                    <th>Valid Until</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (coupons && coupons.length> 0) { %>
                                    <% coupons.forEach(coupon=> { %>
                                        <tr>
                                            <td><b>
                                                    <%= coupon.code %>
                                                </b></td>
                                            <td>
                                                <% if(coupon.discount_type==='Percentage' ) { %>
                                                    <%= coupon.discount_value %>%<% } else { %>₹<%=
                                                                coupon.discount_value %>
                                                                <% } %>
                                            </td>
                                            <td>₹<%= coupon.mincart_value || 0 %>
                                            </td>
                                            <td>
                                                <%= new Date(coupon.expiry_date).toLocaleDateString() %>
                                            </td>
                                            <td>
                                                <!-- Edit Button Pass data as attributes -->
                                                <button class="btn-icon btn-edit"
                                                    onclick="openModal('edit', '<%= coupon._id %>', '<%= coupon.code %>', '<%= coupon.description %>', '<%= coupon.discount_type %>', '<%= coupon.discount_value %>', '<%= coupon.mincart_value %>', '<%= new Date(coupon.expiry_date).toISOString().split('T')[0] %>')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn-icon btn-delete"
                                                    onclick="deleteCoupon('<%= coupon._id %>')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="5" class="text-center">No active coupons</td>
                                                </tr>
                                                <% } %>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div class="pagination">
                        <% if (currentPage> 1) { %><a
                                href="/admin/coupons?page=<%= currentPage - 1 %>&search=<%= search %>">Previous</a>
                            <% } %>
                                <% for(let i=1; i <=totalPages; i++) { %><a
                                        href="/admin/coupons?page=<%= i %>&search=<%= search %>"
                                        class="<%= i === currentPage ? 'active' : '' %>">
                                        <%= i %>
                                    </a>
                                    <% } %>
                                        <% if (currentPage < totalPages) { %><a
                                                href="/admin/coupons?page=<%= currentPage + 1 %>&search=<%= search %>">Next</a>
                                            <% } %>
                    </div>
                </section>
            </div>
    </div>
    <!-- THE MODAL -->
    <div id="couponModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content card-body"> <!-- Reusing card-body class for same style -->
                <div class="modal-header">
                    <h3 id="modalTitle">Add Coupon</h3>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="couponForm">
                        <input type="hidden" id="couponId" name="couponId"> <!-- Hidden ID for Editing -->

                        <div class="form-group">
                            <label>Coupon Code</label>
                            <input type="text" name="code" id="code" class="form-control" placeholder="Ex: SUMMER50"
                                style="text-transform: uppercase;">
                        </div>

                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" name="description" id="description" class="form-control"
                                placeholder="Values summer sale...">
                        </div>
                        <!-- Row 2: Discount -->



                        <!-- Row 2: Discount -->
                        <div class="form-row-grid">
                            <div class="col-6">
                                <label>Discount Type</label>
                                <select name="discount_type" id="discount_type" class="form-control">
                                    <option value="Percentage">Percentage</option>
                                    <option value="Fixed">Fixed Amount</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label>Discount Value</label>
                                <input type="number" name="discount_value" id="discount_value" class="form-control"
                                    placeholder="10" min="1">
                            </div>
                        </div>

                        <!-- Row 3: Validity & Limits -->
                        <div class="form-row-grid">
                            <div class="col-6">
                                <label>Min Cart Value (₹)</label>
                                <input type="number" name="mincart_value" id="mincart_value" class="form-control"
                                    placeholder="0" min="0">
                            </div>
                            <div class="col-6">
                                <label>Expiry Date</label>
                                <input type="date" name="expiry_date" id="expiry_date" class="form-control">
                            </div>
                        </div>


                        <button type="submit" class="btn btn-primary modal-submit-btn">Save Coupon</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="/js/admin/coupenList.js"></script>
</body>

</html>